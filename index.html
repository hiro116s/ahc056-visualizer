<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AHC056 visualizer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding: 20px;
            background-color: #f5f5f5;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background-color: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        h1 {
            color: #333;
            margin-bottom: 20px;
            font-size: 24px;
        }

        .input-section {
            margin-bottom: 20px;
        }

        .input-section label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        .seed-input-group {
            margin-bottom: 30px;
            padding: 15px;
            background-color: #f9f9f9;
            border-radius: 4px;
        }

        .seed-input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        .seed-input-group input[type="number"] {
            width: 200px;
            padding: 8px 12px;
            border: 2px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .seed-input-group input[type="number"]:focus {
            outline: none;
            border-color: #4CAF50;
        }

        textarea {
            width: 100%;
            height: 150px;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            resize: vertical;
            transition: border-color 0.3s;
        }

        textarea:focus {
            outline: none;
            border-color: #4CAF50;
        }

        .mode-selector {
            margin-bottom: 20px;
            padding: 15px;
            background-color: #e3f2fd;
            border-radius: 4px;
            border-left: 4px solid #2196F3;
        }

        .mode-selector h3 {
            margin-bottom: 10px;
            font-size: 16px;
            color: #333;
        }

        .mode-buttons {
            display: flex;
            gap: 10px;
        }

        .mode-button {
            padding: 10px 20px;
            border: 2px solid #2196F3;
            background-color: white;
            color: #2196F3;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s;
        }

        .mode-button:hover {
            background-color: #e3f2fd;
        }

        .mode-button.active {
            background-color: #2196F3;
            color: white;
        }

        .controls {
            margin-bottom: 20px;
            padding: 15px;
            background-color: #f9f9f9;
            border-radius: 4px;
        }

        .controls h3 {
            margin-bottom: 10px;
            font-size: 16px;
            color: #333;
        }

        .checkbox-group {
            display: flex;
            gap: 20px;
        }

        .checkbox-group label {
            display: flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            font-size: 14px;
        }

        .checkbox-group input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .radio-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .radio-group label {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            font-size: 14px;
        }

        .radio-group input[type="radio"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        details {
            margin-bottom: 20px;
            border: 2px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            background-color: #fafafa;
        }

        details[open] {
            background-color: white;
        }

        summary {
            cursor: pointer;
            font-weight: 600;
            font-size: 15px;
            padding: 5px;
            color: #555;
            user-select: none;
        }

        summary:hover {
            color: #2196F3;
        }

        details textarea {
            margin-top: 10px;
        }

        .grid-container {
            border: 2px solid #333;
            display: inline-block;
            background-color: white;
        }

        .grid-table {
            border-collapse: collapse;
        }

        .grid-cell {
            width: 60px;
            height: 60px;
            border: 1px solid #ddd;
            text-align: center;
            vertical-align: middle;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            position: relative;
        }

        .grid-cell-content {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            font-weight: 600;
        }

        .info-section {
            margin-bottom: 20px;
            padding: 15px;
            background-color: #e8f5e9;
            border-radius: 4px;
            border-left: 4px solid #4CAF50;
        }

        .info-section p {
            margin: 5px 0;
            font-size: 14px;
            color: #333;
        }

        .table-container {
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-bottom: 20px;
        }

        table {
            border-collapse: collapse;
            width: 100%;
        }

        th,
        td {
            border: 1px solid #ddd;
            padding: 8px 12px;
            text-align: center;
            font-size: 13px;
            min-width: 60px;
        }

        th {
            background-color: #4CAF50;
            color: white;
            font-weight: 600;
        }

        td:first-child {
            background-color: #f9f9f9;
            font-weight: 600;
        }

        .rule-cell {
            font-family: 'Courier New', monospace;
            font-size: 12px;
            font-weight: 500;
            transition: all 0.15s;
            cursor: pointer;
        }

        .rule-cell:hover {
            transform: scale(1.08);
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.3);
            z-index: 100;
            position: relative;
        }

        .rule-cell.highlighted {
            outline: 5px solid #FF1744;
            outline-offset: -5px;
            z-index: 50;
        }

        .undefined-cell {
            background-color: #f5f5f5;
            color: #999;
            font-style: italic;
        }

        .error-message {
            padding: 15px;
            background-color: #ffebee;
            border-left: 4px solid #f44336;
            border-radius: 4px;
            margin-bottom: 20px;
            color: #c62828;
        }

        .stats-section {
            margin-top: 20px;
            padding: 15px;
            background-color: #f9f9f9;
            border-radius: 4px;
        }

        .stats-section h3 {
            margin-bottom: 15px;
            font-size: 16px;
            color: #333;
        }

        .stats-items {
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-height: 280px;
            overflow-y: auto;
            padding-right: 10px;
        }

        .stats-items::-webkit-scrollbar {
            width: 8px;
        }

        .stats-items::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        .stats-items::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }

        .stats-items::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        .stats-item {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 13px;
            font-family: 'Courier New', monospace;
            padding: 8px;
            border-radius: 4px;
            transition: all 0.15s;
            cursor: pointer;
        }

        .stats-item:hover {
            background-color: #e0e0e0;
            transform: translateX(5px);
        }

        .stats-item.highlighted {
            outline: 5px solid #FF1744;
            outline-offset: -5px;
        }

        .stats-color {
            width: 40px;
            height: 25px;
            border: 1px solid #ddd;
            border-radius: 3px;
            flex-shrink: 0;
        }

        .stats-text {
            flex-grow: 1;
        }

        .stats-count {
            font-weight: 600;
            color: #555;
            min-width: 60px;
            text-align: right;
        }

        /* Robot mode styles */
        .robot-grid-cell {
            position: relative;
            border: 1px solid #ddd;
        }

        .robot-icon {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 24px;
            z-index: 10;
        }

        .target-icon {
            position: absolute;
            top: 5px;
            right: 5px;
            font-size: 16px;
            z-index: 5;
        }

        .cell-color-indicator {
            font-size: 10px;
            font-weight: bold;
            position: absolute;
            top: 2px;
            left: 2px;
        }

        .robot-wall-v {
            position: absolute;
            right: 0;
            top: 0;
            bottom: 0;
            width: 3px;
            background-color: #000;
        }

        .robot-wall-h {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 3px;
            background-color: #000;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>ğŸ¤– AHC056 visualizer</h1>

        <details>
            <summary>ä½¿ã„æ–¹</summary>
            <div style="padding: 15px; background-color: #f9f9f9; border-radius: 4px; margin-top: 10px;">
                <h3 style="margin-top: 0;">åŸºæœ¬æ“ä½œ</h3>
                <ul style="line-height: 1.8;">
                    <li><strong>Seedå…¥åŠ›:</strong>
                        0-999ã®ç¯„å›²ã§ã‚·ãƒ¼ãƒ‰ç•ªå·ã‚’å…¥åŠ›ã™ã‚‹ã¨ã€è‡ªå‹•çš„ã«<code>in/{seed}.txt</code>ã¨<code>out/{seed}.out</code>ã‚’èª­ã¿è¾¼ã¿ã¾ã™ã€‚ã¾ãŸã€å…¥åŠ›ãƒ‡ãƒ¼ã‚¿ã¨å‡ºåŠ›ãƒ‡ãƒ¼ã‚¿ã®æ¬„ã«ç›´æ¥æ–‡å­—åˆ—ã‚’ã‚³ãƒ”ãƒšã—ã¦ä½¿ç”¨ã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™
                    </li>
                    <li><strong>æ›´æ–°ãƒœã‚¿ãƒ³:</strong> å…¥åŠ›ã—ãŸã‚·ãƒ¼ãƒ‰ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å†èª­ã¿è¾¼ã¿ã—ã¾ã™</li>
                    <li><strong>å…¥åŠ›æ¬„ã‚’æŠ˜ã‚Šç•³ã‚€ãƒœã‚¿ãƒ³:</strong> å…¥åŠ›ãƒ‡ãƒ¼ã‚¿ã¨å‡ºåŠ›ãƒ‡ãƒ¼ã‚¿ã®å…¥åŠ›æ¬„ã‚’ä¸€æ‹¬ã§æŠ˜ã‚ŠãŸãŸã¿/å±•é–‹ã—ã¾ã™</li>
                </ul>
                <h3>è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰</h3>
                <ul style="line-height: 1.8;">
                    <li><strong>RuleMap:</strong>
                        é·ç§»è¦å‰‡ã‚’è‰²åˆ†ã‘ã—ã¦è¡¨ã«è¡¨ç¤ºã—ã¾ã™ã€‚åŒã˜(a,s,d)ã®çµ„ã¿åˆã‚ã›ã«ã¯åŒã˜è‰²ãŒä»˜ãã¾ã™ã€‚ã‚»ãƒ«ã‚„ã‚°ãƒ©ãƒ•ã«ãƒã‚¦ã‚¹ã‚’ãƒ›ãƒãƒ¼ã™ã‚‹ã¨ã€åŒã˜è¦å‰‡ãŒãƒã‚¤ãƒ©ã‚¤ãƒˆã•ã‚Œã¾ã™</li>
                    <li><strong>Grid:</strong> ãƒ­ãƒœãƒƒãƒˆã®ç§»å‹•ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œã—ã€å„ã‚»ãƒ«ã®è¨ªå•çµ±è¨ˆã‚’è¡¨ç¤ºã—ã¾ã™ã€‚è¡¨ç¤ºã™ã‚‹ãƒ¡ãƒˆãƒªã‚¯ã‚¹ï¼ˆè¨ªå•å›æ•°ã€ç›´ç·šã€æ›²ãŒã‚Šè§’ãªã©ï¼‰ã‚’é¸æŠã§ãã¾ã™</li>
                    <li><strong>Robot:</strong> ãƒ­ãƒœãƒƒãƒˆã®ç§»å‹•ã‚’1ã‚¹ãƒ†ãƒƒãƒ—ãšã¤ç¢ºèªã§ãã¾ã™ã€‚è‡ªå‹•å†ç”Ÿæ©Ÿèƒ½ã‚‚ã‚ã‚Šã¾ã™</li>
                </ul>
            </div>
        </details>

        <div class="seed-input-group">
            <label for="seedInput">Seed (0-999):</label>
            <input type="number" id="seedInput" min="0" max="999" value="0" placeholder="0">
            <button id="refreshBtn"
                style="margin-left: 10px; padding: 8px 16px; cursor: pointer; background-color: #4CAF50; color: white; border: none; border-radius: 4px;">æ›´æ–°</button>
            <button id="collapseAllBtn"
                style="margin-left: 10px; padding: 8px 16px; cursor: pointer; background-color: #2196F3; color: white; border: none; border-radius: 4px;">å…¥åŠ›æ¬„ã‚’æŠ˜ã‚Šç•³ã‚€</button>
        </div>

        <details open>
            <summary>å…¥åŠ›ãƒ‡ãƒ¼ã‚¿</summary>
            <textarea id="problemInput" placeholder="N K T&#10;v[0] ...&#10;h[0] ...&#10;x[0] y[0]&#10;..."></textarea>
        </details>

        <details open>
            <summary>å‡ºåŠ›ãƒ‡ãƒ¼ã‚¿</summary>
            <textarea id="outputInput"
                placeholder="C Q M&#10;s[0][0] ... s[0][N-1]&#10;...&#10;c q a s d&#10;..."></textarea>
        </details>

        <div class="mode-selector">
            <h3>è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰</h3>
            <div class="mode-buttons">
                <button class="mode-button active" data-mode="rulemap">RuleMap</button>
                <button class="mode-button" data-mode="grid">Grid</button>
                <button class="mode-button" data-mode="robot">Robot</button>
            </div>
        </div>

        <div id="infoSection" style="display: none;"></div>
        <div id="ruleMapControls" class="controls">
            <h3>è¡¨ç¤ºãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ (RuleMap)</h3>
            <div class="checkbox-group">
                <label>
                    <input type="checkbox" id="checkA" checked>
                    <span>a (å¡—ã‚Šæ›¿ãˆã‚‹è‰²)</span>
                </label>
                <label>
                    <input type="checkbox" id="checkS" checked>
                    <span>s (æ–°ã—ã„çŠ¶æ…‹)</span>
                </label>
                <label>
                    <input type="checkbox" id="checkD" checked>
                    <span>d (ç§»å‹•æ–¹å‘)</span>
                </label>
            </div>
        </div>
        <div id="robotControls" class="controls" style="display: none;">
            <h3>ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³åˆ¶å¾¡ (Robot)</h3>
            <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                <button id="btnStep" style="padding: 8px 16px; cursor: pointer;">â–¶ 1ã‚¹ãƒ†ãƒƒãƒ—é€²ã‚€</button>
                <button id="btnReset" style="padding: 8px 16px; cursor: pointer;">ğŸ”„ ãƒªã‚»ãƒƒãƒˆ</button>
                <button id="btnAutoPlay" style="padding: 8px 16px; cursor: pointer;">â¯ è‡ªå‹•å†ç”Ÿ</button>
            </div>
            <div style="margin-top: 10px;">
                <label>é€Ÿåº¦: </label>
                <input type="range" id="speedSlider" min="1" max="10" value="5" style="width: 200px;">
                <span id="speedLabel">5</span>
            </div>
        </div>

        <div id="gridControls" class="controls" style="display: none;">
            <h3>è¡¨ç¤ºãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ (Grid)</h3>
            <div class="radio-group">
                <label>
                    <input type="radio" name="gridMetric" id="metricVisitCount" value="visitCount" checked>
                    <span>è¨ªå•å›æ•° (ã“ã®ã‚»ãƒ«ã‚’è¨ªã‚ŒãŸå›æ•°)</span>
                </label>
                <label>
                    <input type="radio" name="gridMetric" id="metricStraight" value="straight">
                    <span>ç›´ç·š (å‰å›ã¨åŒã˜æ–¹å‘ã«é€²ã‚€å›æ•°)</span>
                </label>
                <label>
                    <input type="radio" name="gridMetric" id="metricTurn" value="turn">
                    <span>æ›²ãŒã‚Šè§’ (å‰å›ã¨é•ã†æ–¹å‘ã«é€²ã‚€å›æ•°)</span>
                </label>
                <label>
                    <input type="radio" name="gridMetric" id="metricStraightCost" value="straightCost">
                    <span>ç›´ç·šã‚³ã‚¹ãƒˆ (æœ€å¾Œã®æ›²ãŒã‚Šè§’ã‚ˆã‚Šå‰ã®ç›´ç·šå›æ•°)</span>
                </label>
                <label>
                    <input type="radio" name="gridMetric" id="metricExpectedCost" value="expectedCost">
                    <span>æœŸå¾…ã‚³ã‚¹ãƒˆ (æ›²ãŒã‚Šè§’ + ç›´ç·šã‚³ã‚¹ãƒˆ)</span>
                </label>
            </div>
        </div>


        <div id="errorSection" style="display: none;"></div>
        <div id="ruleMapSection">
            <div id="tableSection"></div>
            <div id="statsSection"></div>
        </div>
        <div id="gridSection" style="display: none;"></div>
        <div id="robotSection" style="display: none;"></div>
    </div>

    <script>
        // ã‚«ãƒ©ãƒ¼ãƒ‘ãƒ¬ãƒƒãƒˆï¼ˆè¦–è¦šçš„ã«åŒºåˆ¥ã—ã‚„ã™ã„è‰²ï¼‰
        const COLOR_PALETTE = [
            '#FF6B6B', '#4ECDC4', '#45B7D1', '#FFA07A', '#98D8C8',
            '#F7DC6F', '#BB8FCE', '#85C1E2', '#F8B739', '#52B788',
            '#FFB6C1', '#DDA15E', '#06FFA5', '#C77DFF', '#FF9770',
            '#06D6A0', '#FFD23F', '#EE6352', '#59CD90', '#3FA7D6',
            '#FAC748', '#FF5E5B', '#00BBF9', '#F15BB5', '#00F5FF',
            '#9B59B6', '#E74C3C', '#3498DB', '#2ECC71', '#F39C12',
            '#1ABC9C', '#D35400', '#C0392B', '#16A085', '#27AE60',
            '#2980B9', '#8E44AD', '#2C3E50', '#F1C40F', '#E67E22'
        ];

        let parsedData = null;
        let parsedInput = null;
        let parsedOutput = null;
        let colorMap = new Map();
        let colorIndex = 0;
        let currentMode = 'rulemap';

        // Robot mode state
        let robotState = null;
        let autoPlayInterval = null;
        let autoPlaySpeed = 5;

        const seedInput = document.getElementById('seedInput');
        const problemInput = document.getElementById('problemInput');
        const outputInput = document.getElementById('outputInput');
        const checkA = document.getElementById('checkA');
        const checkS = document.getElementById('checkS');
        const checkD = document.getElementById('checkD');

        // Grid mode radio buttons
        const metricRadios = document.querySelectorAll('input[name="gridMetric"]');

        // ãƒ¢ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        document.querySelectorAll('.mode-button').forEach(button => {
            button.addEventListener('click', () => {
                document.querySelectorAll('.mode-button').forEach(b => b.classList.remove('active'));
                button.classList.add('active');
                currentMode = button.getAttribute('data-mode');
                switchMode();
            });
        });

        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        seedInput.addEventListener('input', loadFilesForSeed);
        problemInput.addEventListener('input', parseAndVisualize);
        outputInput.addEventListener('input', parseAndVisualize);

        // æ›´æ–°ãƒœã‚¿ãƒ³
        document.getElementById('refreshBtn').addEventListener('click', loadFilesForSeed);

        // å…¥åŠ›æ¬„ã‚’æŠ˜ã‚Šç•³ã‚€ãƒœã‚¿ãƒ³
        document.getElementById('collapseAllBtn').addEventListener('click', () => {
            const details = document.querySelectorAll('details');
            const allOpen = Array.from(details).every(d => d.open);
            details.forEach(d => d.open = !allOpen);
            document.getElementById('collapseAllBtn').textContent = allOpen ? 'å…¥åŠ›æ¬„ã‚’å±•é–‹ã™ã‚‹' : 'å…¥åŠ›æ¬„ã‚’æŠ˜ã‚Šç•³ã‚€';
        });
        checkA.addEventListener('change', updateVisualization);
        checkS.addEventListener('change', updateVisualization);
        checkD.addEventListener('change', updateVisualization);

        // Grid mode radio button listeners
        metricRadios.forEach(radio => {
            radio.addEventListener('change', updateVisualization);
        });

        // Robot mode controls
        const btnStep = document.getElementById('btnStep');
        const btnReset = document.getElementById('btnReset');
        const btnAutoPlay = document.getElementById('btnAutoPlay');
        const speedSlider = document.getElementById('speedSlider');
        const speedLabel = document.getElementById('speedLabel');

        if (btnStep) btnStep.addEventListener('click', stepRobot);
        if (btnReset) btnReset.addEventListener('click', resetRobot);
        if (btnAutoPlay) btnAutoPlay.addEventListener('click', toggleAutoPlay);
        if (speedSlider) {
            speedSlider.addEventListener('input', (e) => {
                autoPlaySpeed = parseInt(e.target.value);
                speedLabel.textContent = autoPlaySpeed;
            });
        }

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«åˆæœŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚€
        window.addEventListener('DOMContentLoaded', () => {
            loadFilesForSeed();
        });

        function switchMode() {
            if (currentMode === 'rulemap') {
                document.getElementById('ruleMapControls').style.display = 'block';
                document.getElementById('gridControls').style.display = 'none';
                document.getElementById('robotControls').style.display = 'none';
                document.getElementById('ruleMapSection').style.display = 'block';
                document.getElementById('gridSection').style.display = 'none';
                document.getElementById('robotSection').style.display = 'none';
                stopAutoPlay();
            } else if (currentMode === 'grid') {
                document.getElementById('ruleMapControls').style.display = 'none';
                document.getElementById('gridControls').style.display = 'block';
                document.getElementById('robotControls').style.display = 'none';
                document.getElementById('ruleMapSection').style.display = 'none';
                document.getElementById('gridSection').style.display = 'block';
                document.getElementById('robotSection').style.display = 'none';
                stopAutoPlay();
            } else if (currentMode === 'robot') {
                document.getElementById('ruleMapControls').style.display = 'none';
                document.getElementById('gridControls').style.display = 'none';
                document.getElementById('robotControls').style.display = 'block';
                document.getElementById('ruleMapSection').style.display = 'none';
                document.getElementById('gridSection').style.display = 'none';
                document.getElementById('robotSection').style.display = 'block';
            }
            updateVisualization();
        }

        async function loadFilesForSeed() {
            const seed = parseInt(seedInput.value);

            if (isNaN(seed) || seed < 0 || seed >= 2000) {
                return;
            }

            try {
                // å…¥åŠ›ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚€
                const inputResponse = await fetch(`in/${seed}.txt`);
                if (inputResponse.ok) {
                    const inputText = await inputResponse.text();
                    problemInput.value = inputText;
                } else {
                    console.warn(`å…¥åŠ›ãƒ•ã‚¡ã‚¤ãƒ« in/${seed}.txt ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“`);
                }

                // å‡ºåŠ›ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚€
                const outputResponse = await fetch(`out/${seed}.out`);
                if (outputResponse.ok) {
                    const outputText = await outputResponse.text();
                    outputInput.value = outputText;
                } else {
                    console.warn(`å‡ºåŠ›ãƒ•ã‚¡ã‚¤ãƒ« out/${seed}.out ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“`);
                }

                // ã™ã¹ã¦ã®ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿å¾Œã«ãƒ‘ãƒ¼ã‚¹ã¨æç”»ã‚’å®Ÿè¡Œ
                parseAndVisualize();
            } catch (error) {
                console.error('ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
            }
        }

        function parseInput(text) {
            try {
                const lines = text.trim().split('\n');
                if (lines.length < 1) {
                    throw new Error('å…¥åŠ›ãŒç©ºã§ã™');
                }

                const [N, K, T] = lines[0].split(/\s+/).map(Number);
                if (isNaN(N) || isNaN(K) || isNaN(T)) {
                    throw new Error('æœ€åˆã®è¡Œã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆãŒä¸æ­£ã§ã™');
                }

                // å£æƒ…å ±ã‚’èª­ã¿è¾¼ã‚€ (v: ç¸¦ã®å£ã€å„è¡ŒN-1å€‹)
                const wall_v = [];
                for (let i = 0; i < N; i++) {
                    const line = lines[1 + i];
                    if (!line) {
                        throw new Error(`å£æƒ…å ±(v)ã®${i}è¡Œç›®ãŒå­˜åœ¨ã—ã¾ã›ã‚“`);
                    }
                    const row = line.split('').map(c => c === '1');
                    if (row.length !== N - 1) {
                        throw new Error(`å£æƒ…å ±(v)ã®${i}è¡Œç›®ã®é•·ã•ãŒä¸æ­£ã§ã™ï¼ˆæœŸå¾…: ${N - 1}, å®Ÿéš›: ${row.length}ï¼‰`);
                    }
                    wall_v.push(row);
                }

                const wall_h = [];
                for (let i = 0; i < N - 1; i++) {
                    const line = lines[1 + N + i];
                    if (!line) {
                        throw new Error(`å£æƒ…å ±(h)ã®${i}è¡Œç›®ãŒå­˜åœ¨ã—ã¾ã›ã‚“`);
                    }
                    const row = line.split('').map(c => c === '1');
                    if (row.length !== N) {
                        throw new Error(`å£æƒ…å ±(h)ã®${i}è¡Œç›®ã®é•·ã•ãŒä¸æ­£ã§ã™ï¼ˆæœŸå¾…: ${N}, å®Ÿéš›: ${row.length}ï¼‰`);
                    }
                    wall_h.push(row);
                }

                // ç›®çš„åœ°ã‚’èª­ã¿è¾¼ã‚€
                const targets = [];
                for (let i = 0; i < K; i++) {
                    const [x, y] = lines[1 + N + N - 1 + i].split(/\s+/).map(Number);
                    targets.push([x, y]);
                }

                return { N, K, T, wall_v, wall_h, targets };
            } catch (error) {
                throw new Error(`å…¥åŠ›ãƒ‘ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼: ${error.message}`);
            }
        }

        function parseOutput(text) {
            try {
                const lines = text.trim().split('\n');
                if (lines.length < 1) {
                    throw new Error('å…¥åŠ›ãŒç©ºã§ã™');
                }

                const [C, Q, M] = lines[0].split(/\s+/).map(Number);

                if (isNaN(C) || isNaN(Q) || isNaN(M)) {
                    throw new Error('æœ€åˆã®è¡Œã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆãŒä¸æ­£ã§ã™');
                }

                // ã‚°ãƒªãƒƒãƒ‰ã‚µã‚¤ã‚ºã‚’æ¨å®šï¼ˆsé…åˆ—ã®è¡Œæ•°ã‹ã‚‰ï¼‰
                // å„è¡ŒãŒ5ã¤ä»¥ä¸Šã®ãƒˆãƒ¼ã‚¯ãƒ³ã‚’æŒã¡ã€ã™ã¹ã¦ãŒæ•°å€¤ãªã‚‰ã‚°ãƒªãƒƒãƒ‰è¡Œ
                let currentLine = 1;
                const initialColors = [];
                while (currentLine < lines.length) {
                    const tokens = lines[currentLine].trim().split(/\s+/);
                    // ãƒ«ãƒ¼ãƒ«è¡Œï¼ˆc q a s d ã®5ãƒˆãƒ¼ã‚¯ãƒ³ã€æœ€å¾ŒãŒæ–‡å­—ï¼‰ã‹ãƒã‚§ãƒƒã‚¯
                    if (tokens.length === 5 && ['U', 'D', 'L', 'R', 'S'].includes(tokens[4])) {
                        // ãƒ«ãƒ¼ãƒ«è¡Œã®é–‹å§‹ãªã®ã§ã‚°ãƒªãƒƒãƒ‰çµ‚äº†
                        break;
                    }
                    // ã‚°ãƒªãƒƒãƒ‰è¡Œã¨ã—ã¦èª­ã¿è¾¼ã¿
                    const row = tokens.map(Number);
                    if (row.some(isNaN)) {
                        // æ•°å€¤ã§ãªã„ã‚‚ã®ãŒã‚ã‚Œã°ã‚°ãƒªãƒƒãƒ‰çµ‚äº†
                        break;
                    }
                    initialColors.push(row);
                    currentLine++;
                }

                const N = initialColors.length;

                // é·ç§»è¦å‰‡ã‚’è§£æ
                const rules = new Map();
                for (let i = currentLine; i < lines.length; i++) {
                    const tokens = lines[i].trim().split(/\s+/);
                    if (tokens.length !== 5) continue;

                    const c = parseInt(tokens[0]);
                    const q = parseInt(tokens[1]);
                    const a = parseInt(tokens[2]);
                    const s = parseInt(tokens[3]);
                    const d = tokens[4];

                    if (isNaN(c) || isNaN(q) || isNaN(a) || isNaN(s)) continue;

                    rules.set(`${c},${q}`, { a, s, d });
                }

                return { C, Q, M, N, initialColors, rules };
            } catch (error) {
                throw new Error(`ãƒ‘ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼: ${error.message}`);
            }
        }

        function getRuleKey(a, s, d, checkStates) {
            const parts = [];
            if (checkStates.a) parts.push(`a${a}`);
            if (checkStates.s) parts.push(`s${s}`);
            if (checkStates.d) parts.push(`d${d}`);
            return parts.join('_');
        }

        function getColorForRule(a, s, d, checkStates) {
            const key = getRuleKey(a, s, d, checkStates);

            if (!colorMap.has(key)) {
                colorMap.set(key, COLOR_PALETTE[colorIndex % COLOR_PALETTE.length]);
                colorIndex++;
            }

            return colorMap.get(key);
        }

        function formatRule(a, s, d, checkStates) {
            const parts = [];
            if (checkStates.a) parts.push(`${a}`);
            if (checkStates.s) parts.push(`${s}`);
            if (checkStates.d) parts.push(`${d}`);
            return parts.join(',');
        }

        function updateVisualization() {
            if (currentMode === 'rulemap') {
                if (parsedOutput) {
                    // è‰²ãƒãƒƒãƒ—ã‚’ãƒªã‚»ãƒƒãƒˆ
                    colorMap.clear();
                    colorIndex = 0;
                    visualizeRuleMap(parsedOutput);
                } else {
                    document.getElementById('infoSection').style.display = 'none';
                    document.getElementById('tableSection').innerHTML = '';
                    document.getElementById('statsSection').innerHTML = '';
                }
            } else if (currentMode === 'grid') {
                if (parsedInput && parsedOutput) {
                    visualizeGrid(parsedInput, parsedOutput);
                } else {
                    document.getElementById('gridSection').innerHTML = `
                        <div class="error-message">
                            Gridãƒ¢ãƒ¼ãƒ‰ã‚’ä½¿ç”¨ã™ã‚‹ã«ã¯ã€å…¥åŠ›ãƒ‡ãƒ¼ã‚¿ã¨å‡ºåŠ›ãƒ‡ãƒ¼ã‚¿ã®ä¸¡æ–¹ãŒå¿…è¦ã§ã™ã€‚
                        </div>
                    `;
                    document.getElementById('infoSection').innerHTML = `
                        <div class="info-section">
                            <p><strong>çŠ¶æ…‹:</strong> ${parsedInput ? 'å…¥åŠ›ãƒ‡ãƒ¼ã‚¿: OK' : 'å…¥åŠ›ãƒ‡ãƒ¼ã‚¿: ãªã—'}, ${parsedOutput ? 'å‡ºåŠ›ãƒ‡ãƒ¼ã‚¿: OK' : 'å‡ºåŠ›ãƒ‡ãƒ¼ã‚¿: ãªã—'}</p>
                        </div>
                    `;
                    document.getElementById('infoSection').style.display = 'block';
                }
            } else if (currentMode === 'robot') {
                if (parsedInput && parsedOutput) {
                    resetRobot();
                } else {
                    document.getElementById('robotSection').innerHTML = `
                        <div class="error-message">
                            Robotãƒ¢ãƒ¼ãƒ‰ã‚’ä½¿ç”¨ã™ã‚‹ã«ã¯ã€å…¥åŠ›ãƒ‡ãƒ¼ã‚¿ã¨å‡ºåŠ›ãƒ‡ãƒ¼ã‚¿ã®ä¸¡æ–¹ãŒå¿…è¦ã§ã™ã€‚
                        </div>
                    `;
                    document.getElementById('infoSection').innerHTML = `
                        <div class="info-section">
                            <p><strong>çŠ¶æ…‹:</strong> ${parsedInput ? 'å…¥åŠ›ãƒ‡ãƒ¼ã‚¿: OK' : 'å…¥åŠ›ãƒ‡ãƒ¼ã‚¿: ãªã—'}, ${parsedOutput ? 'å‡ºåŠ›ãƒ‡ãƒ¼ã‚¿: OK' : 'å‡ºåŠ›ãƒ‡ãƒ¼ã‚¿: ãªã—'}</p>
                        </div>
                    `;
                    document.getElementById('infoSection').style.display = 'block';
                }
            }
        }

        function parseAndVisualize() {
            const inputText = problemInput.value;
            const outputText = outputInput.value;

            document.getElementById('errorSection').innerHTML = '';
            document.getElementById('errorSection').style.display = 'none';

            // å…¥åŠ›ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ‘ãƒ¼ã‚¹
            if (inputText.trim()) {
                try {
                    parsedInput = parseInput(inputText);
                } catch (error) {
                    document.getElementById('errorSection').innerHTML += `
                        <div class="error-message">
                            å…¥åŠ›ãƒ‡ãƒ¼ã‚¿ã‚¨ãƒ©ãƒ¼: ${error.message}
                        </div>
                    `;
                    document.getElementById('errorSection').style.display = 'block';
                    parsedInput = null;
                }
            }

            // å‡ºåŠ›ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ‘ãƒ¼ã‚¹
            if (outputText.trim()) {
                try {
                    parsedOutput = parseOutput(outputText);
                } catch (error) {
                    document.getElementById('errorSection').innerHTML += `
                        <div class="error-message">
                            å‡ºåŠ›ãƒ‡ãƒ¼ã‚¿ã‚¨ãƒ©ãƒ¼: ${error.message}
                        </div>
                    `;
                    document.getElementById('errorSection').style.display = 'block';
                    parsedOutput = null;
                }
            }

            updateVisualization();
        }

        function visualizeRuleMap(data) {
            const { C, Q, M, rules } = data;

            const checkStates = {
                a: checkA.checked,
                s: checkS.checked,
                d: checkD.checked
            };

            // æƒ…å ±ã‚»ã‚¯ã‚·ãƒ§ãƒ³
            document.getElementById('infoSection').innerHTML = `
                <div class="info-section">
                    <p><strong>è‰²æ•° (C):</strong> ${C}</p>
                    <p><strong>çŠ¶æ…‹æ•° (Q):</strong> ${Q}</p>
                    <p><strong>é·ç§»è¦å‰‡æ•° (M):</strong> ${M}</p>
                    <p><strong>å®šç¾©ã•ã‚ŒãŸè¦å‰‡:</strong> ${rules.size} / ${C * Q}</p>
                </div>
            `;
            document.getElementById('infoSection').style.display = 'block';

            // ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ (Cè¡ŒQåˆ—)
            let tableHTML = '<div class="table-container"><table>';

            // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œ
            tableHTML += '<tr><th>c \\ q</th>';
            for (let q = 0; q < Q; q++) {
                tableHTML += `<th>${q}</th>`;
            }
            tableHTML += '</tr>';

            // ãƒ‡ãƒ¼ã‚¿è¡Œ
            for (let c = 0; c < C; c++) {
                tableHTML += `<tr><td>${c}</td>`;
                for (let q = 0; q < Q; q++) {
                    const key = `${c},${q}`;
                    if (rules.has(key)) {
                        const rule = rules.get(key);
                        const color = getColorForRule(rule.a, rule.s, rule.d, checkStates);
                        const ruleKey = getRuleKey(rule.a, rule.s, rule.d, checkStates);
                        const text = formatRule(rule.a, rule.s, rule.d, checkStates);
                        const title = `c=${c}, q=${q} â†’ a=${rule.a}, s=${rule.s}, d=${rule.d}`;
                        tableHTML += `<td class="rule-cell" data-rule-key="${ruleKey}" style="background-color: ${color}; color: white;" title="${title}">${text}</td>`;
                    } else {
                        tableHTML += '<td class="undefined-cell">-</td>';
                    }
                }
                tableHTML += '</tr>';
            }

            tableHTML += '</table></div>';
            document.getElementById('tableSection').innerHTML = tableHTML;

            // å„é·ç§»è¦å‰‡ã®å‡ºç¾å›æ•°ã‚’è¨ˆç®—
            const ruleCount = new Map();
            rules.forEach((rule, key) => {
                const ruleKey = getRuleKey(rule.a, rule.s, rule.d, checkStates);
                ruleCount.set(ruleKey, (ruleCount.get(ruleKey) || 0) + 1);
            });

            // å‡ºç¾å›æ•°ã§ã‚½ãƒ¼ãƒˆï¼ˆé™é †ï¼‰
            const sortedRules = Array.from(ruleCount.entries())
                .sort((a, b) => b[1] - a[1]);

            // çµ±è¨ˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ä½œæˆ
            let statsHTML = '<div class="stats-section"><h3>é·ç§»è¦å‰‡çµ±è¨ˆï¼ˆä½¿ç”¨å›æ•°é †ï¼‰</h3><div class="stats-items">';

            for (const [ruleKey, count] of sortedRules) {
                const color = colorMap.get(ruleKey);
                // ruleKeyã‹ã‚‰å…ƒã®ãƒ«ãƒ¼ãƒ«ã‚’æ¢ã™
                let sampleRule = null;
                for (const [key, rule] of rules.entries()) {
                    if (getRuleKey(rule.a, rule.s, rule.d, checkStates) === ruleKey) {
                        sampleRule = rule;
                        break;
                    }
                }
                const text = formatRule(sampleRule.a, sampleRule.s, sampleRule.d, checkStates);
                const fullText = `a=${sampleRule.a}, s=${sampleRule.s}, d=${sampleRule.d}`;
                statsHTML += `
                    <div class="stats-item" data-rule-key="${ruleKey}" title="${fullText}">
                        <div class="stats-color" style="background-color: ${color};"></div>
                        <div class="stats-text">${text}</div>
                        <div class="stats-count">${count}å›</div>
                    </div>
                `;
            }

            statsHTML += '</div></div>';
            document.getElementById('statsSection').innerHTML = statsHTML;

            // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ 
            addHighlightListeners();
        }

        function visualizeGrid(inputData, outputData) {
            if (!inputData || !outputData) {
                document.getElementById('gridSection').innerHTML = `
                    <div class="error-message">
                        Gridãƒ¢ãƒ¼ãƒ‰ã‚’ä½¿ç”¨ã™ã‚‹ã«ã¯ã€å…¥åŠ›ãƒ‡ãƒ¼ã‚¿ã¨å‡ºåŠ›ãƒ‡ãƒ¼ã‚¿ã®ä¸¡æ–¹ãŒå¿…è¦ã§ã™ã€‚
                    </div>
                `;
                document.getElementById('infoSection').style.display = 'none';
                return;
            }

            const { N, K, T, wall_v, wall_h, targets } = inputData;
            const { initialColors, rules } = outputData;

            console.log('Grid visualization started');
            console.log('N:', N, 'K:', K, 'T:', T);
            console.log('wall_v length:', wall_v.length);
            console.log('wall_h length:', wall_h.length);
            console.log('initialColors length:', initialColors.length);
            console.log('targets:', targets);

            // ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œ
            // å„ã‚»ãƒ«ã®è¨ªå•æƒ…å ±ã‚’è¨˜éŒ²
            const visitData = Array(N).fill(0).map(() =>
                Array(N).fill(0).map(() => ({
                    straight: 0,        // ç›´ç·šå›æ•°
                    turn: 0,            // æ›²ãŒã‚Šè§’å›æ•°
                    straightCost: 0,    // ç›´ç·šã‚³ã‚¹ãƒˆï¼ˆæœ€å¾Œã®æ›²ãŒã‚Šè§’ã‚ˆã‚Šå‰ã®ç›´ç·šå›æ•°ï¼‰
                    expectedCost: 0,    // æœŸå¾…ã‚³ã‚¹ãƒˆï¼ˆæ›²ãŒã‚Šè§’ + ç›´ç·šã‚³ã‚¹ãƒˆï¼‰
                    visitCount: 0,      // ã“ã®ã‚»ãƒ«ã‚’è¨ªã‚ŒãŸå›æ•°
                    moves: []           // ã“ã®ã‚»ãƒ«ã§ã®å…¨ã¦ã®ç§»å‹•å±¥æ­´ï¼ˆæ–¹å‘ï¼‰
                }))
            );

            let pos = targets[0];
            let state = 0;
            let colors = initialColors.map(row => [...row]);
            let prevDir = null;
            let targetIndex = 1;

            console.log('Initial pos:', pos);
            console.log('colors dimensions:', colors.length, 'x', colors[0]?.length);

            const dirMap = { 'U': [-1, 0], 'D': [1, 0], 'L': [0, -1], 'R': [0, 1], 'S': [0, 0] };

            let prev_dir = null;
            for (let step = 0; step < T; step++) {
                const [r, c] = pos;

                // ç¯„å›²ãƒã‚§ãƒƒã‚¯
                if (r < 0 || r >= N || c < 0 || c >= N) {
                    console.error('Position out of bounds:', r, c);
                    break;
                }

                if (!colors[r] || colors[r][c] === undefined) {
                    console.error('Invalid color access:', r, c, 'colors[r]:', colors[r]);
                    break;
                }

                const currentColor = colors[r][c];
                const key = `${currentColor},${state}`;

                if (!rules.has(key)) break;

                const rule = rules.get(key);
                colors[r][c] = rule.a;
                state = rule.s;

                const dir = rule.d;
                const [dr, dc] = dirMap[dir];

                // ç§»å‹•å¯èƒ½ã‹ãƒã‚§ãƒƒã‚¯
                let canMove = true;
                if (dir !== 'S') {
                    const nr = r + dr;
                    const nc = c + dc;
                    if (nr < 0 || nr >= N || nc < 0 || nc >= N) {
                        canMove = false;
                    } else {
                        // å£ãƒã‚§ãƒƒã‚¯
                        if (dr === 0 && dc !== 0) { // å·¦å³ç§»å‹•
                            const minC = Math.min(c, nc);
                            if (r < wall_v.length && minC >= 0 && minC < wall_v[r].length) {
                                if (wall_v[r][minC]) {
                                    canMove = false;
                                }
                            }
                        } else if (dc === 0 && dr !== 0) { // ä¸Šä¸‹ç§»å‹•
                            const minR = Math.min(r, nr);
                            if (minR >= 0 && minR < wall_h.length && c >= 0 && c < wall_h[minR].length) {
                                if (wall_h[minR][c]) {
                                    canMove = false;
                                }
                            }
                        }
                    }
                }

                if (canMove && dir !== 'S') {
                    // ç¾åœ¨ã®ã‚»ãƒ« (r, c) ã«ç§»å‹•ã‚’è¨˜éŒ²
                    visitData[r][c].visitCount++;
                    visitData[r][c].moves.push(prev_dir === null || dir === prev_dir);

                    // ã“ã®ã‚»ãƒ«ã§ã®ç§»å‹•å±¥æ­´ã‹ã‚‰çµ±è¨ˆã‚’è¨ˆç®—
                    const moves = visitData[r][c].moves;
                    let straightCount = 0;
                    let turnCount = 0;
                    let straightCost = 0;

                    // æœ€å¾Œã®ã‚¿ãƒ¼ãƒ³ã‚ˆã‚Šå‰ã®ç›´ç·šå›æ•°ã‚’è¨ˆç®—
                    let lastTurnIndex = -1;
                    for (let i = 0; i < moves.length; i++) {
                        if (!moves[i]) {
                            lastTurnIndex = i;
                            turnCount++;
                        }
                    }

                    // å„ç§»å‹•ãŒç›´ç·šã‹ã‚¿ãƒ¼ãƒ³ã‹ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
                    for (let i = 0; i < moves.length; i++) {
                        if (moves[i]) {
                            straightCount++;
                            if (i < lastTurnIndex) {
                                straightCost++;
                            }
                        }
                    }

                    visitData[r][c].straight = straightCount;
                    visitData[r][c].turn = turnCount;
                    visitData[r][c].straightCost = straightCost;
                    visitData[r][c].expectedCost = turnCount + straightCost;

                    prevDir = dir;
                    pos = [r + dr, c + dc];

                    // ç›®çš„åœ°ãƒã‚§ãƒƒã‚¯
                    if (pos[0] === targets[targetIndex][0] && pos[1] === targets[targetIndex][1]) {
                        targetIndex++;
                    }
                }
                prev_dir = dir;
                if (targetIndex == K) {
                    break;
                }
            }

            // é¸æŠã•ã‚Œã¦ã„ã‚‹ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’å–å¾—
            const selectedMetric = document.querySelector('input[name="gridMetric"]:checked')?.value || 'straight';

            // æœ€å¤§å€¤ã‚’è¨ˆç®—ï¼ˆã‚«ãƒ©ãƒ¼ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ç”¨ï¼‰
            let maxValue = 0;
            for (let i = 0; i < N; i++) {
                for (let j = 0; j < N; j++) {
                    const value = visitData[i][j][selectedMetric];
                    if (value > maxValue) maxValue = value;
                }
            }

            // ã‚°ãƒªãƒƒãƒ‰è¡¨ç¤º
            let gridHTML = '<div class="grid-container"><table class="grid-table">';
            for (let i = 0; i < N; i++) {
                gridHTML += '<tr>';
                for (let j = 0; j < N; j++) {
                    const data = visitData[i][j];
                    const displayValue = data[selectedMetric];

                    // ã‚«ãƒ©ãƒ¼ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³è¨ˆç®—
                    let bgColor = 'white';
                    if (displayValue > 0 && maxValue > 0) {
                        const intensity = Math.min(displayValue / maxValue, 1);
                        // ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã”ã¨ã«ç•°ãªã‚‹è‰²ã‚’ä½¿ç”¨
                        if (selectedMetric === 'visitCount') {
                            bgColor = `rgba(156, 39, 176, ${intensity})`;  // ç´«
                        } else if (selectedMetric === 'straight') {
                            bgColor = `rgba(76, 175, 80, ${intensity})`;  // ç·‘
                        } else if (selectedMetric === 'turn') {
                            bgColor = `rgba(255, 152, 0, ${intensity})`;  // ã‚ªãƒ¬ãƒ³ã‚¸
                        } else if (selectedMetric === 'straightCost') {
                            bgColor = `rgba(33, 150, 243, ${intensity})`;  // é’
                        } else if (selectedMetric === 'expectedCost') {
                            bgColor = `rgba(233, 30, 99, ${intensity})`;  // ãƒ”ãƒ³ã‚¯
                        }
                    }

                    gridHTML += `<td class="grid-cell" style="background-color: ${bgColor};" 
                        title="ä½ç½®: (${i}, ${j})\nè¨ªå•å›æ•°: ${data.visitCount}\nç›´ç·š: ${data.straight}\næ›²ãŒã‚Šè§’: ${data.turn}\nç›´ç·šã‚³ã‚¹ãƒˆ: ${data.straightCost}\næœŸå¾…ã‚³ã‚¹ãƒˆ: ${data.expectedCost}">
                        <div class="grid-cell-content">${displayValue}</div>`;

                    // å£ã‚’æç”»
                    if (j < N - 1 && wall_v[i] && wall_v[i][j]) {
                        gridHTML += '<div class="robot-wall-v"></div>';
                    }
                    if (i < N - 1 && wall_h[i] && wall_h[i][j]) {
                        gridHTML += '<div class="robot-wall-h"></div>';
                    }

                    gridHTML += `</td>`;
                }
                gridHTML += '</tr>';
            }
            gridHTML += '</table></div>';

            // é›†è¨ˆæƒ…å ±ã‚’è¨ˆç®—
            let totalVisitCount = 0;
            let totalStraight = 0;
            let totalTurn = 0;
            let totalStraightCost = 0;
            let totalExpectedCost = 0;

            for (let i = 0; i < N; i++) {
                for (let j = 0; j < N; j++) {
                    totalVisitCount += visitData[i][j].visitCount;
                    totalStraight += visitData[i][j].straight;
                    totalTurn += visitData[i][j].turn;
                    totalStraightCost += visitData[i][j].straightCost;
                    totalExpectedCost += visitData[i][j].expectedCost;
                }
            }

            document.getElementById('infoSection').innerHTML = `
                <div class="info-section">
                    <p><strong>ã‚°ãƒªãƒƒãƒ‰ã‚µã‚¤ã‚º (N):</strong> ${N}</p>
                    <p><strong>ç›®çš„åœ°æ•° (K):</strong> ${K}</p>
                    <p><strong>ã‚¹ãƒ†ãƒƒãƒ—ä¸Šé™ (T):</strong> ${T}</p>
                    <p><strong>åˆ°é”ã—ãŸç›®çš„åœ°:</strong> ${targetIndex} / ${K}</p>
                    <p><strong>è¡¨ç¤ºãƒ¡ãƒˆãƒªã‚¯ã‚¹:</strong> ${selectedMetric === 'visitCount' ? 'è¨ªå•å›æ•°' :
                    selectedMetric === 'straight' ? 'ç›´ç·š' :
                        selectedMetric === 'turn' ? 'æ›²ãŒã‚Šè§’' :
                            selectedMetric === 'straightCost' ? 'ç›´ç·šã‚³ã‚¹ãƒˆ' :
                                selectedMetric === 'expectedCost' ? 'æœŸå¾…ã‚³ã‚¹ãƒˆ' : selectedMetric
                }</p>
                    <hr style="margin: 10px 0; border: none; border-top: 1px solid #ddd;">
                    <p><strong>é›†è¨ˆæƒ…å ±:</strong></p>
                    <p style="margin-left: 20px;"><strong>è¨ªå•å›æ•°ã®åˆè¨ˆ:</strong> ${totalVisitCount}</p>
                    <p style="margin-left: 20px;"><strong>ç›´ç·šå›æ•°ã®åˆè¨ˆ:</strong> ${totalStraight}</p>
                    <p style="margin-left: 20px;"><strong>æ›²ãŒã‚Šè§’å›æ•°ã®åˆè¨ˆ:</strong> ${totalTurn}</p>
                    <p style="margin-left: 20px;"><strong>ç›´ç·šã‚³ã‚¹ãƒˆã®åˆè¨ˆ:</strong> ${totalStraightCost}</p>
                    <p style="margin-left: 20px;"><strong>æœŸå¾…ã‚³ã‚¹ãƒˆã®åˆè¨ˆ:</strong> ${totalExpectedCost}</p>
                </div>
            `;
            document.getElementById('gridSection').innerHTML = gridHTML;
            document.getElementById('infoSection').style.display = 'block';
        }

        function addHighlightListeners() {
            // ãƒ†ãƒ¼ãƒ–ãƒ«ã®ã‚»ãƒ«ã«ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ 
            document.querySelectorAll('.rule-cell').forEach(cell => {
                cell.addEventListener('mouseenter', function () {
                    const ruleKey = this.getAttribute('data-rule-key');
                    highlightRules(ruleKey);
                });
                cell.addEventListener('mouseleave', function () {
                    clearHighlight();
                });
            });

            // çµ±è¨ˆã‚¢ã‚¤ãƒ†ãƒ ã«ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ 
            document.querySelectorAll('.stats-item').forEach(item => {
                item.addEventListener('mouseenter', function () {
                    const ruleKey = this.getAttribute('data-rule-key');
                    highlightRules(ruleKey);
                });
                item.addEventListener('mouseleave', function () {
                    clearHighlight();
                });
            });
        }

        function highlightRules(ruleKey) {
            // ã™ã¹ã¦ã®åŒã˜ruleKeyã‚’æŒã¤ã‚»ãƒ«ã¨çµ±è¨ˆã‚¢ã‚¤ãƒ†ãƒ ã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆ
            document.querySelectorAll(`[data-rule-key="${ruleKey}"]`).forEach(elem => {
                elem.classList.add('highlighted');
            });
        }

        function clearHighlight() {
            document.querySelectorAll('.highlighted').forEach(elem => {
                elem.classList.remove('highlighted');
            });
        }

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«0.outã‚’èª­ã¿è¾¼ã‚€å‡¦ç†ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ‰‹å‹•ã§è²¼ã‚Šä»˜ã‘ã‚‹ã“ã¨ã‚’æƒ³å®š

        // ==================== Robot Mode Functions ====================

        // ã‚¸ãƒ£ãƒƒã‚¸ã‚³ãƒ¼ãƒ‰ã¨åŒã˜è‰²è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯
        function computeColor(val, maxVal) {
            let normalizedVal = val / maxVal;
            normalizedVal = Math.min(1.0, Math.max(0.0, normalizedVal));

            let r, g, b;
            if (normalizedVal < 0.5) {
                const x = normalizedVal * 2.0;
                r = 30.0 * (1.0 - x) + 144.0 * x;
                g = 144.0 * (1.0 - x) + 255.0 * x;
                b = 255.0 * (1.0 - x) + 30.0 * x;
            } else {
                const x = normalizedVal * 2.0 - 1.0;
                r = 144.0 * (1.0 - x) + 255.0 * x;
                g = 255.0 * (1.0 - x) + 30.0 * x;
                b = 30.0 * (1.0 - x) + 70.0 * x;
            }

            const rInt = Math.round(r);
            const gInt = Math.round(g);
            const bInt = Math.round(b);

            return `#${rInt.toString(16).padStart(2, '0')}${gInt.toString(16).padStart(2, '0')}${bInt.toString(16).padStart(2, '0')}`;
        }

        function initRobotState() {
            if (!parsedInput || !parsedOutput) return null;

            const { N, K, T, wall_v, wall_h, targets } = parsedInput;
            const { initialColors, rules } = parsedOutput;

            return {
                step: 0,
                maxSteps: T,
                pos: [...targets[0]],
                state: 0,
                colors: initialColors.map(row => [...row]),
                targetIndex: 1,
                targets: targets,
                rules: rules,
                wall_v: wall_v,
                wall_h: wall_h,
                N: N,
                K: K,
                finished: false,
                history: []
            };
        }

        function resetRobot() {
            stopAutoPlay();
            robotState = initRobotState();
            renderRobotGrid();
        }

        function stepRobot() {
            if (!robotState || robotState.finished) return;

            const { pos, state, colors, rules, wall_v, wall_h, N, targets, targetIndex } = robotState;
            const [r, c] = pos;

            const currentColor = colors[r][c];
            const key = `${currentColor},${state}`;

            if (!rules.has(key)) {
                robotState.finished = true;
                renderRobotGrid();
                return;
            }

            const rule = rules.get(key);

            robotState.history.push({
                step: robotState.step,
                pos: [...pos],
                color: currentColor,
                state: state,
                rule: rule
            });

            colors[r][c] = rule.a;
            robotState.state = rule.s;

            const dirMap = { 'U': [-1, 0], 'D': [1, 0], 'L': [0, -1], 'R': [0, 1], 'S': [0, 0] };
            const [dr, dc] = dirMap[rule.d] || [0, 0];

            let canMove = true;
            if (rule.d !== 'S') {
                const nr = r + dr;
                const nc = c + dc;

                if (nr < 0 || nr >= N || nc < 0 || nc >= N) {
                    canMove = false;
                } else {
                    if (dr === 0 && dc !== 0) {
                        const minC = Math.min(c, nc);
                        if (r < wall_v.length && minC >= 0 && minC < wall_v[r].length) {
                            if (wall_v[r][minC]) {
                                canMove = false;
                            }
                        }
                    } else if (dc === 0 && dr !== 0) {
                        const minR = Math.min(r, nr);
                        if (minR >= 0 && minR < wall_h.length && c >= 0 && c < wall_h[minR].length) {
                            if (wall_h[minR][c]) {
                                canMove = false;
                            }
                        }
                    }
                }

                if (canMove) {
                    robotState.pos = [nr, nc];

                    if (targetIndex < targets.length &&
                        nr === targets[targetIndex][0] &&
                        nc === targets[targetIndex][1]) {
                        robotState.targetIndex++;

                        if (robotState.targetIndex >= targets.length) {
                            robotState.finished = true;
                        }
                    }
                }
            }

            robotState.step++;

            if (robotState.step >= robotState.maxSteps) {
                robotState.finished = true;
            }

            renderRobotGrid();
        }

        function renderRobotGrid() {
            if (!robotState) return;

            const { N, pos, state, colors, targets, targetIndex, step, maxSteps, finished, K, wall_v, wall_h } = robotState;
            const [robotR, robotC] = pos;

            // C (æœ€å¤§è‰²æ•°) ã‚’è¨ˆç®—
            const C = parsedOutput ? parsedOutput.C : Math.max(...colors.flat()) + 1;

            const currentColor = colors[robotR][robotC];
            document.getElementById('infoSection').innerHTML = `
                <div class="info-section">
                    <p><strong>ã‚¹ãƒ†ãƒƒãƒ—:</strong> ${step} / ${maxSteps}</p>
                    <p><strong>ä½ç½®:</strong> (${robotR}, ${robotC})</p>
                    <p><strong>ç¾åœ¨ã®è‰²:</strong> ${currentColor}</p>
                    <p><strong>å†…éƒ¨çŠ¶æ…‹:</strong> ${state}</p>
                    <p><strong>åˆ°é”ã—ãŸç›®çš„åœ°:</strong> ${targetIndex} / ${K}</p>
                    <p><strong>çŠ¶æ…‹:</strong> ${finished ? 'çµ‚äº†' : 'å®Ÿè¡Œä¸­'}</p>
                </div>
            `;
            document.getElementById('infoSection').style.display = 'block';

            const D = 50;
            let gridHTML = '<div class="grid-container"><table class="grid-table">';

            for (let i = 0; i < N; i++) {
                gridHTML += '<tr>';
                for (let j = 0; j < N; j++) {
                    const cellColor = colors[i][j];
                    const isRobot = (i === robotR && j === robotC);
                    const isTarget = targetIndex < targets.length &&
                        i === targets[targetIndex][0] &&
                        j === targets[targetIndex][1];

                    // ã‚¸ãƒ£ãƒƒã‚¸ã‚³ãƒ¼ãƒ‰ã¨åŒã˜è‰²è¨ˆç®—ã‚’ä½¿ç”¨
                    const bgColor = computeColor(cellColor, C);

                    gridHTML += `<td class="robot-grid-cell" style="width: ${D}px; height: ${D}px; background-color: ${bgColor};" title="ä½ç½®: (${i}, ${j})\nè‰²: ${cellColor}">`;
                    gridHTML += `<div class="cell-color-indicator" style="color: white; text-shadow: 1px 1px 2px black;">${cellColor}</div>`;

                    if (isRobot) {
                        gridHTML += '<div class="robot-icon">ğŸ¤–</div>';
                    }
                    if (isTarget) {
                        gridHTML += '<div class="target-icon">ğŸš©</div>';
                    }

                    if (j < N - 1 && wall_v[i] && wall_v[i][j]) {
                        gridHTML += '<div class="robot-wall-v"></div>';
                    }
                    if (i < N - 1 && wall_h[i] && wall_h[i][j]) {
                        gridHTML += '<div class="robot-wall-h"></div>';
                    }

                    gridHTML += '</td>';
                }
                gridHTML += '</tr>';
            }

            gridHTML += '</table></div>';
            document.getElementById('robotSection').innerHTML = gridHTML;
        }

        function toggleAutoPlay() {
            if (autoPlayInterval) {
                stopAutoPlay();
            } else {
                startAutoPlay();
            }
        }

        function startAutoPlay() {
            if (!robotState || robotState.finished) return;

            const btnAutoPlay = document.getElementById('btnAutoPlay');
            btnAutoPlay.textContent = 'â¸ åœæ­¢';

            const delay = 1000 / autoPlaySpeed;
            autoPlayInterval = setInterval(() => {
                if (robotState && !robotState.finished) {
                    stepRobot();
                } else {
                    stopAutoPlay();
                }
            }, delay);
        }

        function stopAutoPlay() {
            if (autoPlayInterval) {
                clearInterval(autoPlayInterval);
                autoPlayInterval = null;
                const btnAutoPlay = document.getElementById('btnAutoPlay');
                if (btnAutoPlay) {
                    btnAutoPlay.textContent = 'â¯ è‡ªå‹•å†ç”Ÿ';
                }
            }
        }
    </script>
</body>

</html>